<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Volleyball Â· Sign Up</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,600;1,9..144,300&display=swap" rel="stylesheet" />
  <style>
    /* â”€â”€ Reset & Base â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #f5f3ee;
      --surface: #ffffff;
      --border: #ddd8cf;
      --text: #1a1814;
      --muted: #8a8278;
      --accent: #2d5a3d;
      --accent-light: #eef3f0;
      --waitlist: #7a5230;
      --waitlist-light: #f5efe8;
      --danger: #b94040;
      --danger-light: #fdf0f0;
      --spot-empty: #e8e4dc;
      --radius: 6px;
      --mono: 'DM Mono', monospace;
      --serif: 'Fraunces', Georgia, serif;
    }

    html { scroll-behavior: smooth; }

    body {
      font-family: var(--mono);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      font-size: 14px;
      line-height: 1.6;
    }

    /* â”€â”€ Layout â”€â”€ */
    .page {
      max-width: 760px;
      margin: 0 auto;
      padding: 48px 24px 80px;
    }

    /* â”€â”€ Header â”€â”€ */
    .header {
      margin-bottom: 48px;
      padding-bottom: 24px;
      border-bottom: 1px solid var(--border);
    }

    .header-top {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }

    h1 {
      font-family: var(--serif);
      font-weight: 300;
      font-size: 2.4rem;
      letter-spacing: -0.02em;
      line-height: 1;
    }

    h1 em {
      font-style: italic;
      color: var(--accent);
    }

    .status-badge {
      font-size: 11px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      padding: 4px 10px;
      border-radius: 20px;
      font-weight: 500;
      white-space: nowrap;
    }
    .status-badge.open  { background: var(--accent-light); color: var(--accent); }
    .status-badge.closed { background: #eee; color: var(--muted); }

    .header-sub {
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
    }

    /* â”€â”€ Section titles â”€â”€ */
    .section-title {
      font-family: var(--mono);
      font-size: 10px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 14px;
      font-weight: 500;
    }

    /* â”€â”€ Spot Grid â”€â”€ */
    .spots-section { margin-bottom: 40px; }

    .spots-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .spots-count {
      font-family: var(--serif);
      font-size: 1.1rem;
      font-weight: 300;
    }

    .spots-count strong {
      font-weight: 600;
      color: var(--accent);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }

    @media (max-width: 480px) {
      .grid { grid-template-columns: repeat(3, 1fr); }
    }

    .spot {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 10px 12px;
      min-height: 52px;
      display: flex;
      align-items: center;
      font-size: 12px;
      line-height: 1.3;
      transition: border-color 0.15s;
      position: relative;
    }

    .spot.empty {
      background: var(--spot-empty);
      border-color: transparent;
      color: var(--muted);
      font-size: 11px;
    }

    .spot.extra {
      border-style: dashed;
      color: var(--muted);
      font-size: 11px;
    }

    .spot-number {
      position: absolute;
      top: 5px;
      right: 7px;
      font-size: 9px;
      color: var(--muted);
      opacity: 0.5;
    }

    /* â”€â”€ Waitlist â”€â”€ */
    .waitlist-section { margin-bottom: 40px; }

    .waitlist-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .waitlist-item {
      background: var(--waitlist-light);
      border: 1px solid #e2d5c5;
      border-radius: var(--radius);
      padding: 10px 14px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 13px;
    }

    .waitlist-pos {
      font-family: var(--serif);
      font-style: italic;
      color: var(--waitlist);
      font-size: 1rem;
      min-width: 20px;
    }

    .waitlist-name { flex: 1; }

    .waitlist-extras {
      font-size: 11px;
      color: var(--muted);
    }

    .waitlist-empty {
      color: var(--muted);
      font-size: 13px;
      font-style: italic;
    }

    /* â”€â”€ Divider â”€â”€ */
    hr { border: none; border-top: 1px solid var(--border); margin: 40px 0; }

    /* â”€â”€ Forms â”€â”€ */
    .forms-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    @media (max-width: 560px) {
      .forms-grid { grid-template-columns: 1fr; }
    }

    .form-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 22px;
    }

    .form-card h3 {
      font-family: var(--serif);
      font-weight: 300;
      font-size: 1.15rem;
      margin-bottom: 18px;
      line-height: 1.2;
    }

    .field { margin-bottom: 14px; }

    label {
      display: block;
      font-size: 11px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 5px;
      font-weight: 500;
    }

    input, select {
      width: 100%;
      padding: 9px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--bg);
      font-family: var(--mono);
      font-size: 13px;
      color: var(--text);
      outline: none;
      transition: border-color 0.15s;
    }

    input:focus, select:focus {
      border-color: var(--accent);
    }

    input::placeholder { color: var(--muted); }

    /* â”€â”€ Buttons â”€â”€ */
    .btn {
      display: inline-block;
      padding: 10px 20px;
      border: none;
      border-radius: var(--radius);
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing: 0.04em;
      cursor: pointer;
      transition: opacity 0.15s, transform 0.1s;
      font-weight: 500;
      width: 100%;
      text-align: center;
    }

    .btn:hover { opacity: 0.85; }
    .btn:active { transform: scale(0.98); }

    .btn-primary { background: var(--accent); color: #fff; }
    .btn-secondary { background: var(--border); color: var(--text); }
    .btn-danger { background: var(--danger-light); color: var(--danger); border: 1px solid #e8c0c0; }

    .btn:disabled { opacity: 0.4; cursor: not-allowed; }

    /* â”€â”€ Alerts / Results â”€â”€ */
    .alert {
      padding: 12px 14px;
      border-radius: var(--radius);
      font-size: 12.5px;
      line-height: 1.5;
      margin-top: 14px;
    }
    .alert.success { background: var(--accent-light); border: 1px solid #c0d9c8; color: #1e4a2c; }
    .alert.error   { background: var(--danger-light); border: 1px solid #e8c0c0; color: var(--danger); }
    .alert.info    { background: var(--waitlist-light); border: 1px solid #e2d5c5; color: var(--waitlist); }

    .code-display {
      font-family: var(--mono);
      font-size: 1.4rem;
      font-weight: 500;
      letter-spacing: 0.15em;
      color: var(--accent);
      display: block;
      margin: 8px 0 4px;
    }

    /* â”€â”€ Manage Panel â”€â”€ */
    .manage-panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 22px;
      margin-top: 16px;
    }

    .manage-panel h4 {
      font-family: var(--serif);
      font-weight: 300;
      font-size: 1rem;
      margin-bottom: 14px;
      color: var(--muted);
    }

    .manage-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }

    .manage-row input { flex: 1; }

    /* â”€â”€ Settings â”€â”€ */
    .settings-section {
      margin-top: 40px;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
    }

    @media (max-width: 480px) {
      .settings-grid { grid-template-columns: 1fr; }
    }

    .settings-note {
      margin-top: 10px;
      font-size: 11px;
      color: var(--muted);
    }

    /* â”€â”€ Footer â”€â”€ */
    .footer {
      margin-top: 60px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
      color: var(--muted);
      font-size: 11px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* â”€â”€ Loading â”€â”€ */
    .loading {
      color: var(--muted);
      font-size: 12px;
      padding: 20px 0;
      text-align: center;
      letter-spacing: 0.05em;
    }

    /* â”€â”€ Refresh â”€â”€ */
    .refresh-btn {
      background: none;
      border: 1px solid var(--border);
      color: var(--muted);
      padding: 4px 10px;
      font-family: var(--mono);
      font-size: 11px;
      border-radius: 20px;
      cursor: pointer;
      transition: border-color 0.15s;
    }
    .refresh-btn:hover { border-color: var(--accent); color: var(--accent); }

    /* â”€â”€ Fade in â”€â”€ */
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .fadein { animation: fadeUp 0.3s ease forwards; }

    /* â”€â”€ Manage tabs â”€â”€ */
    .tab-row {
      display: flex;
      gap: 6px;
      margin-bottom: 16px;
    }
    .tab-btn {
      padding: 6px 14px;
      border: 1px solid var(--border);
      border-radius: 20px;
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: 0.04em;
      cursor: pointer;
      background: transparent;
      color: var(--muted);
      transition: all 0.15s;
    }
    .tab-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }

    .hidden { display: none; }
  </style>
</head>
<body>

<div class="page">

  <!-- â”€â”€ Header â”€â”€ -->
  <header class="header">
    <div class="header-top">
      <h1>Volley<em>ball</em></h1>
      <span id="regStatusBadge" class="status-badge closed">Loadingâ€¦</span>
    </div>
    <p class="header-sub" id="headerSub">Checking registration windowâ€¦</p>
  </header>

  <!-- â”€â”€ Player Grid â”€â”€ -->
  <section class="spots-section">
    <div class="spots-meta">
      <p class="section-title">Players</p>
      <div style="display:flex;align-items:center;gap:10px;">
        <span class="spots-count" id="spotsCount">â€” / 12</span>
        <button class="refresh-btn" onclick="loadData()">â†» Refresh</button>
      </div>
    </div>
    <div class="grid" id="playerGrid">
      <div class="loading">Loadingâ€¦</div>
    </div>
  </section>

  <!-- â”€â”€ Waitlist â”€â”€ -->
  <section class="waitlist-section">
    <p class="section-title">Waitlist</p>
    <div class="waitlist-list" id="waitlistList">
      <div class="loading">Loadingâ€¦</div>
    </div>
  </section>

  <hr />

  <!-- â”€â”€ Register + Manage â”€â”€ -->
  <div class="forms-grid">

    <!-- Register -->
    <div class="form-card" id="registerCard">
      <h3>Sign<br /><em style="font-style:italic;">yourself up</em></h3>

      <div class="field">
        <label for="regName">Your name</label>
        <input type="text" id="regName" placeholder="e.g. Maria" maxlength="40" />
      </div>

      <div class="field">
        <label for="regExtra">Extra guests</label>
        <select id="regExtra">
          <option value="0">Just me</option>
          <option value="1">+ 1 extra</option>
          <option value="2">+ 2 extra</option>
          <option value="3">+ 3 extra</option>
        </select>
      </div>

      <button class="btn btn-primary" id="regBtn" onclick="handleRegister()">Register</button>

      <div id="regResult"></div>
    </div>

    <!-- Manage -->
    <div class="form-card">
      <h3>Manage<br /><em style="font-style:italic;">reservation</em></h3>

      <div class="field">
        <label for="manageCode">Confirmation code</label>
        <input type="text" id="manageCode" placeholder="e.g. AB3X9Z" maxlength="10"
               oninput="this.value=this.value.toUpperCase()" />
      </div>

      <button class="btn btn-secondary" onclick="handleCheck()">Look up</button>

      <div id="manageResult"></div>
    </div>

  </div>

  <!-- â”€â”€ Settings (visible after master code lookup) â”€â”€ -->
  <section class="settings-section hidden" id="settingsSection">
    <hr />
    <p class="section-title">Registration Window Settings</p>
    <p style="font-size:12px;color:var(--muted);margin-bottom:16px;">
      These settings control when registration opens and closes each week.
      Edit them directly in the <strong>Settings</strong> sheet in your Google Spreadsheet,
      or use this panel (master code required to see this).
    </p>
    <div class="settings-grid" id="settingsDisplay"></div>
    <p class="settings-note">Day values: 0=Sun, 1=Mon, 2=Tue, 3=Wed, 4=Thu, 5=Fri, 6=Sat</p>
  </section>

  <!-- â”€â”€ Footer â”€â”€ -->
  <footer class="footer">
    <span>Weekly volleyball signup</span>
    <span id="lastUpdated"></span>
  </footer>

</div>

<script>
// ============================================================
// CONFIG â€” paste your Apps Script Web App URL here
// ============================================================
const API_URL = "https://script.google.com/macros/s/AKfycbzVN3CB9w_qFl2wq7Xqv3ONpIEATFv6rtgQaqOoNpTr0Po8FLs4meqX1cnGQMn-bkFh/exec;

// ============================================================
// State
// ============================================================
let publicData = null;
const DAY_NAMES = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];

// ============================================================
// API
// ============================================================
async function apiFetch(action, params = {}) {
  params.action = action;
  const url = API_URL + "?" + new URLSearchParams(params);
  const res = await fetch(url);
  return res.json();
}

// All calls go via GET â€” Apps Script blocks JSON POST from browsers (CORS preflight)
async function apiPost(body) {
  const url = API_URL + "?" + new URLSearchParams(body);
  const res = await fetch(url);
  return res.json();
}

// ============================================================
// Load & Render Public Data
// ============================================================
async function loadData() {
  try {
    publicData = await apiFetch("getPublicData");
    renderGrid(publicData);
    renderWaitlist(publicData);
    renderHeader(publicData);
    document.getElementById("lastUpdated").textContent = "Updated " + new Date().toLocaleTimeString();
  } catch(e) {
    document.getElementById("playerGrid").innerHTML = '<div class="loading">Could not load data. Check API_URL.</div>';
  }
}

function renderHeader(data) {
  const badge = document.getElementById("regStatusBadge");
  const sub   = document.getElementById("headerSub");
  const s = data.settings;
  const openDay  = DAY_NAMES[s.open_day]  || "â€”";
  const closeDay = DAY_NAMES[s.close_day] || "â€”";
  const gameDay  = DAY_NAMES[s.game_day]  || "â€”";

  const fmt = h => {
    const ampm = h >= 12 ? "PM" : "AM";
    return ((h % 12) || 12) + ":00 " + ampm;
  };

  if (data.registrationOpen) {
    badge.textContent = "Open";
    badge.className = "status-badge open";
    sub.textContent = `Registration open Â· Closes ${closeDay} at ${fmt(s.close_hour)} Â· Game on ${gameDay}`;
  } else {
    badge.textContent = "Closed";
    badge.className = "status-badge closed";
    sub.textContent = `Registration opens ${openDay} at ${fmt(s.open_hour)} Â· Game on ${gameDay}`;
  }

  // Disable register button if closed
  const regBtn = document.getElementById("regBtn");
  regBtn.disabled = !data.registrationOpen;
  if (!data.registrationOpen) {
    regBtn.title = "Registration is currently closed";
  }
}

function renderGrid(data) {
  const grid = document.getElementById("playerGrid");
  const spotsCount = document.getElementById("spotsCount");
  const total = data.totalSpots;
  const players = data.players || [];

  spotsCount.innerHTML = `<strong>${players.length}</strong> / ${total}`;

  let html = "";
  for (let i = 0; i < total; i++) {
    const p = players[i];
    if (p) {
      html += `
        <div class="spot fadein ${p.isExtra ? 'extra' : ''}">
          <span class="spot-number">${i+1}</span>
          ${escHtml(p.name)}
        </div>`;
    } else {
      html += `<div class="spot empty"><span class="spot-number">${i+1}</span>â€”</div>`;
    }
  }
  grid.innerHTML = html;
}

function renderWaitlist(data) {
  const list = document.getElementById("waitlistList");
  const wl = data.waitlist || [];
  if (wl.length === 0) {
    list.innerHTML = '<div class="waitlist-empty">No one on the waitlist</div>';
    return;
  }
  list.innerHTML = wl.map(w => `
    <div class="waitlist-item fadein">
      <span class="waitlist-pos">${w.position}</span>
      <span class="waitlist-name">${escHtml(w.name)}</span>
      ${w.extras > 0 ? `<span class="waitlist-extras">+${w.extras} guest${w.extras > 1 ? 's' : ''}</span>` : ''}
    </div>
  `).join("");
}

// ============================================================
// Register
// ============================================================
async function handleRegister() {
  const name = document.getElementById("regName").value.trim();
  const extra = parseInt(document.getElementById("regExtra").value) || 0;
  const resultEl = document.getElementById("regResult");
  const btn = document.getElementById("regBtn");

  if (!name) {
    resultEl.innerHTML = '<div class="alert error">Please enter your name.</div>';
    return;
  }

  btn.disabled = true;
  btn.textContent = "Registeringâ€¦";
  resultEl.innerHTML = "";

  try {
    const res = await apiPost({ action: "register", name, extraCount: extra });
    if (res.success) {
      let alertClass = "success";
      let msg = "You're registered!";
      if (res.status === "waitlist") {
        alertClass = "info";
        msg = `You're on the waitlist (position ${res.waitlistPosition}).`;
      } else if (res.status === "split") {
        alertClass = "info";
        const playerPart = res.extrasAsPlayer > 0
          ? `You and ${res.extrasAsPlayer} guest(s) are registered.`
          : "You are registered.";
        msg = `${playerPart} ${res.extrasAsWaitlist} guest(s) couldn't fit and are on the waitlist (position ${res.waitlistPosition}).`;
      }
      resultEl.innerHTML = `
        <div class="alert ${alertClass} fadein">
          ${msg}
          <br />Save your code:
          <span class="code-display">${res.code}</span>
          You'll need it to modify or cancel.
        </div>`;
      document.getElementById("regName").value = "";
      document.getElementById("regExtra").value = "0";
      loadData();
    } else {
      resultEl.innerHTML = `<div class="alert error fadein">${escHtml(res.error)}</div>`;
    }
  } catch(e) {
    resultEl.innerHTML = `<div class="alert error fadein">Network error. Please try again.</div>`;
  }

  btn.disabled = !publicData?.registrationOpen;
  btn.textContent = "Register";
}

// ============================================================
// Check / Manage
// ============================================================
async function handleCheck() {
  const code = document.getElementById("manageCode").value.trim().toUpperCase();
  const resultEl = document.getElementById("manageResult");

  if (!code) {
    resultEl.innerHTML = '<div class="alert error">Enter a confirmation code.</div>';
    return;
  }

  resultEl.innerHTML = '<div class="loading">Looking upâ€¦</div>';

  try {
    const res = await apiPost({ action: "check", code });
    if (!res.success) {
      resultEl.innerHTML = `<div class="alert error fadein">${escHtml(res.error)}</div>`;
      return;
    }

    if (res.isMaster) {
      renderMasterPanel(res, resultEl, code);
      document.getElementById("settingsSection").classList.remove("hidden");
      if (publicData?.settings) renderSettings(publicData.settings);
      return;
    }

    renderManagePanel(res, resultEl, code);
  } catch(e) {
    resultEl.innerHTML = `<div class="alert error fadein">Network error.</div>`;
  }
}

function renderManagePanel(res, el, code) {
  const isWaitlist = res.status === "waitlist";
  el.innerHTML = `
    <div class="manage-panel fadein">
      <h4>${isWaitlist ? "Waitlist" : "Player"} Â· <em>${escHtml(res.name)}</em></h4>
      ${isWaitlist ? `<div class="alert info" style="margin-bottom:12px;">Waitlist position: <strong>${res.waitlistPosition}</strong></div>` : ""}

      <div class="tab-row">
        <button class="tab-btn active" onclick="showTab('edit','${code}')">Edit name</button>
        <button class="tab-btn" onclick="showTab('extras','${code}')">Change guests</button>
        <button class="tab-btn" onclick="showTab('cancel','${code}')">Cancel</button>
      </div>

      <div id="tab-edit">
        <div class="manage-row">
          <input type="text" id="editName" placeholder="New name" maxlength="40" value="${escAttr(res.name)}" />
          <button class="btn btn-primary" style="width:auto;padding:9px 14px;" onclick="handleUpdate('${code}','name')">Save</button>
        </div>
      </div>

      <div id="tab-extras" class="hidden">
        <div class="manage-row">
          <select id="editExtra">
            <option value="0" ${res.extraCount===0?'selected':''}>Just me</option>
            <option value="1" ${res.extraCount===1?'selected':''}>+ 1 extra</option>
            <option value="2" ${res.extraCount===2?'selected':''}>+ 2 extra</option>
            <option value="3" ${res.extraCount===3?'selected':''}>+ 3 extra</option>
          </select>
          <button class="btn btn-primary" style="width:auto;padding:9px 14px;" onclick="handleUpdate('${code}','extras')">Save</button>
        </div>
      </div>

      <div id="tab-cancel" class="hidden">
        <p style="font-size:12px;color:var(--muted);margin-bottom:10px;">This will remove you ${isWaitlist ? 'from the waitlist' : 'from the game'}.</p>
        <button class="btn btn-danger" onclick="handleCancel('${code}',null)">Confirm cancellation</button>
      </div>

      <div id="manageActionResult"></div>
    </div>`;
}

function renderMasterPanel(res, el, code) {
  const all = res.allRegistrations || [];
  const rows = all.map(r => `
    <div class="waitlist-item" style="flex-wrap:wrap;gap:6px;">
      <span style="min-width:60px;font-size:11px;color:var(--muted);">${r.Status === 'player' ? 'ðŸŸ¢' : 'ðŸŸ¡'} ${r.Status}</span>
      <span style="flex:1;">${escHtml(r.Name)} ${r.ExtraCount > 0 ? `<span style="color:var(--muted)">+${r.ExtraCount}</span>` : ''}</span>
      <button class="tab-btn" style="font-size:10px;padding:3px 8px;" onclick="masterCancel('${code}','${r.ID}',this)">Cancel</button>
    </div>`).join("") || '<div class="waitlist-empty">No registrations yet.</div>';

  el.innerHTML = `
    <div class="manage-panel fadein">
      <h4>Master View â€” All Registrations</h4>
      ${rows}
      <div id="masterActionResult" style="margin-top:10px;"></div>
    </div>`;
}

function showTab(tab, code) {
  ["edit","extras","cancel"].forEach(t => {
    const el = document.getElementById("tab-" + t);
    if (el) el.classList.toggle("hidden", t !== tab);
  });
  document.querySelectorAll(".tab-btn").forEach((btn, i) => {
    btn.classList.toggle("active", ["edit","extras","cancel"][i] === tab);
  });
}

async function handleUpdate(code, type) {
  const resultEl = document.getElementById("manageActionResult");
  let body = { action: "update", code };

  if (type === "name") {
    body.newName = document.getElementById("editName").value.trim();
    if (!body.newName) { resultEl.innerHTML = '<div class="alert error">Name cannot be empty.</div>'; return; }
  } else {
    body.newExtraCount = parseInt(document.getElementById("editExtra").value) || 0;
  }

  resultEl.innerHTML = '<div class="loading">Savingâ€¦</div>';
  try {
    const res = await apiPost(body);
    resultEl.innerHTML = `<div class="alert ${res.success ? 'success' : 'error'} fadein">${escHtml(res.message || res.error)}</div>`;
    if (res.success) loadData();
  } catch { resultEl.innerHTML = '<div class="alert error fadein">Network error.</div>'; }
}

async function handleCancel(code, targetId) {
  const resultEl = document.getElementById("manageActionResult") || document.getElementById("masterActionResult");
  resultEl.innerHTML = '<div class="loading">Cancellingâ€¦</div>';
  try {
    const res = await apiPost({ action: "cancel", code, targetId });
    resultEl.innerHTML = `<div class="alert ${res.success ? 'success' : 'error'} fadein">${escHtml(res.message || res.error)}</div>`;
    if (res.success) {
      loadData();
      document.getElementById("manageResult").innerHTML = "";
      document.getElementById("manageCode").value = "";
    }
  } catch { resultEl.innerHTML = '<div class="alert error fadein">Network error.</div>'; }
}

async function masterCancel(masterCode, targetId, btn) {
  btn.disabled = true;
  btn.textContent = "â€¦";
  const resultEl = document.getElementById("masterActionResult");
  try {
    const res = await apiPost({ action: "cancel", code: masterCode, targetId });
    resultEl.innerHTML = `<div class="alert ${res.success ? 'success' : 'error'} fadein">${escHtml(res.message || res.error)}</div>`;
    if (res.success) { loadData(); handleCheck(); }
  } catch { resultEl.innerHTML = '<div class="alert error fadein">Network error.</div>'; }
}

// ============================================================
// Settings display (master only)
// ============================================================
function renderSettings(s) {
  const grid = document.getElementById("settingsDisplay");
  const dayName = d => DAY_NAMES[d] || d;
  const rows = [
    ["Registration opens", `${dayName(s.open_day)} at ${s.open_hour}:00`],
    ["Registration closes", `${dayName(s.close_day)} at ${s.close_hour}:00`],
    ["Game day", dayName(s.game_day)],
    ["Timezone", s.timezone],
  ];
  grid.innerHTML = rows.map(([k,v]) => `
    <div>
      <label style="margin-bottom:3px;">${k}</label>
      <div style="font-size:13px;">${v}</div>
    </div>`).join("");
}

// ============================================================
// Utilities
// ============================================================
function escHtml(str) {
  return String(str || "")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;");
}
function escAttr(str) { return escHtml(str); }

// ============================================================
// Enter key support
// ============================================================
document.addEventListener("keydown", e => {
  if (e.key === "Enter") {
    if (document.activeElement.id === "regName" || document.activeElement.id === "regExtra") handleRegister();
    if (document.activeElement.id === "manageCode") handleCheck();
  }
});

// ============================================================
// Init
// ============================================================
loadData();
setInterval(loadData, 60000); // auto-refresh every minute
</script>
</body>
</html>
